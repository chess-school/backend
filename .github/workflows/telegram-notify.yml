# –ò–º—è –Ω–∞—à–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ GitHub Actions
name: Telegram Notification

# –¢—Ä–∏–≥–≥–µ—Ä: –Ω–∞ —á—Ç–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞—à –ø—Ä–æ—Ü–µ—Å—Å
on:
  push:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É 'main'
    branches:
      - main
    # –ï—Å–ª–∏ –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è 'master', –∑–∞–º–µ–Ω–∏—Ç–µ 'main' –Ω–∞ 'master'

# –ó–∞–¥–∞—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
jobs:
  send_notification:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ Ubuntu
    runs-on: ubuntu-latest

    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–æ–¥—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # –ù–∞–º –Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
          fetch-depth: 2

      # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
      - name: Get commit information and escape markdown
        id: commit_info
        run: |
          # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã MarkdownV2
          escape_markdown() {
            echo "$1" | sed -e 's/_/\\_/g' -e 's/\*/\\*/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/~/\\~/g' -e 's/`/\\`/g' -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/+/\\+/g' -e 's/-/\\-/g' -e 's/=/\\=/g' -e 's/|/\\|/g' -e 's/{/\\{/g' -e 's/}/\\}/g' -e 's/\./\\./g' -e 's/!/\\!/g'
          }

          # –ü–æ–ª—É—á–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
          RAW_AUTHOR=$(git log -1 --pretty=format:'%an')
          RAW_MESSAGE=$(git log -1 --pretty=format:'%s')
          RAW_HASH=$(git log -1 --pretty=format:'%h')

          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
          AUTHOR=$(escape_markdown "$RAW_AUTHOR")
          MESSAGE=$(escape_markdown "$RAW_MESSAGE")
          HASH=$(escape_markdown "$RAW_HASH")

          # –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
          URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          # –ü–µ—Ä–µ–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏
          echo "commit_author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_message=$MESSAGE" >> $GITHUB_OUTPUT
          echo "commit_hash=$HASH" >> $GITHUB_OUTPUT
          echo "commit_url=$URL" >> $GITHUB_OUTPUT

      # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
      - name: Send Telegram message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdownv2 # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å markdownv2, —Ç.–∫. –º—ã –≤—Å–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∏
          message: |
            *–ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç –Ω–∞ –±–µ–∫–µ–Ω–¥–µ –≤ –≤–µ—Ç–∫–µ `main`* üöÄ

            *–ê–≤—Ç–æ—Ä:* ${{ steps.commit_info.outputs.commit_author }}
            *–°–æ–æ–±—â–µ–Ω–∏–µ:* `${{ steps.commit_info.outputs.commit_message }}`
